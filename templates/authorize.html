<!DOCTYPE html>
<html>

<head>
    {% include 'oauth_head.html' %}
</head>

<body id="page-top" onload='window.getAccountAddress()'>
    <div id="wrapper">
        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-md-9 col-lg-10 col-xl-8">
                            <div class="card shadow o-hidden border-0 my-5" style="color: rgb(133,135,150);"> 
                                <div  class="p-5"> 
                                    <img style="width: 96px;  display: block;  margin-left: auto; margin-right: auto;"  src="{{ url_for('static', filename='img/logo_noir.png')}}">
                                    <br><br>
                                    <div id="id_text" class="text-center" >Allow this company to access your Digital Identity ?.</div>
                                    <form id="myform" action="" method="POST">
                                        <input id="id_data" value="" name="data" hidden type="text" >
                                        <input id="id_signature" value="" name="signature" hidden type="text" >
                                        <input id="id_did" value="" name="did" hidden type="text" >
                                        <div id='connected' hidden></div>
                                        <div class="form-group">
                                            {% if openid == 'checked' %}
                                            <div class="form-inline custom-control-inline">
                                                <div class="form-check"><input type="hidden" class="form-check-input" value={{openid}} type="checkbox" name="openid" ><label class="form-check-label" ></label></div>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div class="form-group">
                                            {% if profile == 'checked' %}
                                            <div class="form-inline custom-control-inline">
                                                <div class="form-check"><input class="form-check-input" {{profile}} type="checkbox" name="profile" ><label class="form-check-label" >I authorize this application to access my public profile.</label></div>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div class="form-group">
                                            {% if address == 'checked' %}
                                            <div class="form-inline custom-control-inline">
                                                <div class="form-check"><input class="form-check-input" {{address}} type="checkbox" name="address" ><label class="form-check-label" >I authorize this application to access my postal address.</label></div>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div class="form-group">
                                            {% if about == 'checked' %}
                                            <div class="form-inline custom-control-inline">
                                                <div class="form-check"><input class="form-check-input" {{about}} type="checkbox" name="about" ><label class="form-check-label" >I authorize this application to access my description.</label></div>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div class="form-group">
                                            {% if birthdate == 'checked' %}
                                            <div class="form-inline custom-control-inline">
                                                <div class="form-check"><input class="form-check-input" {{birthdate}} type="checkbox" name="birthdate" ><label class="form-check-label" >I authorize this application to access my birthdate.</label></div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="form-group">
                                            {% if resume == 'checked' %}
                                            <div class="form-inline custom-control-inline">
                                                <div class="form-check"><input class="form-check-input" {{resume}} type="checkbox" name="resume"><label class="form-check-label" >I authorize this application to access my professional resume.</label></div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="form-group">
                                            {% if proof_of_identity == 'checked' %}
                                            <div class="form-inline custom-control-inline">
                                                <div class="form-check"><input class="form-check-input"  {{proof_of_identity}} type="checkbox" name="proof_of_identity"><label class="form-check-label" >I authorize this application to access my proof of identity.</label></div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="form-group">
                                            {% if email == 'checked' %}
                                            <div class="form-inline custom-control-inline">
                                                <div class="form-check"><input class="form-check-input" {{email}} type="checkbox" name="email" ><label class="form-check-label" >I authorize this application to access my email.</label></div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="form-group">
                                            {% if phone == 'checked' %}
                                            <div class="form-inline custom-control-inline">
                                                <div class="form-check"><input class="form-check-input" {{phone}} type="checkbox" name="phone" ><label class="form-check-label" >I authorize this application to access my phone number.</label></div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="form-group">
                                            {% if user_manage_referent == 'checked' %}
                                            <div class="form-inline custom-control-inline">
                                            <div class="form-check"><input class="form-check-input"  type="checkbox" {{user_manage_referent}} name="user:manage:referent" ><label class="form-check-label" ><p>I authorize this application to add or remove referents from my Identity.</p></label></div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="form-group">
                                            {% if user_manage_partner == 'checked' %}
                                            <div class="form-inline custom-control-inline">
                                            <div class="form-check"><input class="form-check-input" type="checkbox" {{user_manage_partner}} name="user:manage:partner" ><label class="form-check-label" >I authorize this application to manage my parnerships.</label></div>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div class="form-group">
                                            {% if user_manage_certificate == 'checked' %}
                                            <div class="form-inline custom-control-inline">
                                            <div class="form-check"><input class="form-check-input" type="checkbox" {{user_manage_certificate}} name="user:manage:certificate" ><label class="form-check-label" ><p>I authorize this application to issue or delete certificates with my signature.</p></label></div>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div class="form-group">
                                            {% if user_manage_data == 'checked' %}
                                            <div class="form-inline custom-control-inline">
                                            <div class="form-check"><input class="form-check-input" type="checkbox" {{user_manage_data}} name="user:manage:data" ><label class="form-check-label" ><p>I authorize this application to update or delete data of your settings.</p></label></div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <br>
                                        <div id="id_spinner" class="text-center"></div>

                                        <div class="form-row">
                                            <div class="col-4 col-xl-3">
                                                <div  id="id_button"  class="form-group"><buttontitle="" onclick="signuserinfo()" class="btn btn-primary text-white btn-user" type="button">Allow</button></div>
                                            </div>
                                            <div class="col-4 col-xl-3">
                                                <div id="id_button_reject"  class="form-group"><button class="btn btn-primary text-white btn-user" onclick="window.onEnd()" name ="reject" type="submit">Reject</button></div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="text-center"><a class="small" onclick="End()" href="#" >Change account</a></div>
                                <br>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="{{ url_for('static', filename='jquery-3.5.1.slim.min.js') }}"></script>
    <script src="{{ url_for('static', filename='bs-init.js') }}"></script>
    <script src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='oidc-talao.min.js') }}"></script>

<script> async function signuserinfo(){
    document.getElementById("id_spinner").innerHTML = '<div class="spinner-border"></div>';
    document.getElementById("id_button").innerHTML = '';
    document.getElementById("id_button_reject").innerHTML = ''
    document.getElementById("id_text").innerHTML = 'Waiting for wallet to access Digital Identity...';
    /*
    In this option we send back the private key encrypted with the rsa key of the client
    
    const result = await window.getAesEncrypted('{{workspace_contract_to}}');
    console.log('result = ', result);
    const message = JSON.stringify({'aesEncrypted' : result[0], 'workspace_contract' : result[1]})
    document.getElementById("id_text").innerHTML = 'Waiting for wallet signature to send data...';
    const signature = await window.sign(message);
    
    In this option we send back did_authn in plain text as an IDtoken
    The token is build by the server
    */
    const IDtoken = await getDidAuthn();
    document.getElementById("id_text").innerHTML = 'Waiting for wallet signature to send data...';
    // signature of the did authn only
    const signature = await window.sign(IDtoken['data']);
    // pass all data server through the form
    document.getElementById("id_data").value = IDtoken['data'];
    document.getElementById("id_did").value = IDtoken['did'];
    document.getElementById("id_signature").value = signature;
    // smartphone session is over
    window.onEnd();
    document.getElementById("myform").submit();
}
</script>

<script> function End() {
    window.onEnd();
    window.location.href = "/api/v1/oauth_login";
  }
  </script>

</body>

</html>